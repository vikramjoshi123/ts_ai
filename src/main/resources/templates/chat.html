<!DOCTYPE html>
<html>
<head>
    <title>Touchstone Ollama Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        #chatBox {
            white-space: pre-wrap;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h4>Touchstone Chat (Ollama)</h4>
        </div>
        <div class="card-body">
            <form id="chatForm" class="mb-3">
                <div class="input-group">
                    <input type="text" class="form-control" id="prompt" placeholder="Type command or question..." required>
                    <button class="btn btn-primary">Send</button>
                </div>
            </form>
            <pre id="chatBox"></pre>
        </div>
    </div>
</div>

<script>
    $(function(){
        $('#chatForm').submit(function(e){
            e.preventDefault();
            const prompt = $('#prompt').val();
            if (!prompt.trim()) return;

            $('#chatBox').append('You: ' + prompt + '\n');
            $('#prompt').val('');

            const es = new EventSource('/chat/ask?prompt=' + encodeURIComponent(prompt));

            es.onmessage = function(e) {
                let data = e.data;

                if (data === '[DONE]') {
                    $('#chatBox').append('\n\n'); // spacing after full response
                    es.close();
                    return;
                }

                // Remove any leading "data: " if present
                data = data.replace(/^data:\s*/i, '');

                // Split into words and append word by word
                const words = data.split(/\s+/);
                let index = 0;

                function appendWord() {
                    if (index < words.length) {
                        $('#chatBox').append(words[index] + ' ');
                        index++;
                        setTimeout(appendWord, 50); // delay between words (ms)
                        $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight); // auto scroll
                    }
                }
                appendWord();
            };

            es.onerror = function() {
                es.close();
                $('#chatBox').append('\n[Error streaming response]\n\n');
            };
        });
    });
</script>

</body>
</html>
